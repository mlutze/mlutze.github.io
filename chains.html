<!DOCTYPE html>
<html>
<head>
    <script>

        const TAU = Math.PI * 2;

        // list of node info: { id: number, name: String }
        let nodes = [];

        // list of edge info: { id: String, src: String, dest: String }
        let edges = [];

        let selectedSrc = null;

        function randomId(prefix) {
            return prefix + Math.floor(Math.random() * 1000000);
        }

        function extractId(namedId) {
            let regex = /^[a-z]*([0-9])+$/
            return parseInt(namedId.match(regex)[1]);
        }

        function mkId(prefix, id) {
            return prefix + id;
        }

        function toCartesian(r, theta) {
            let x = r * Math.cos(theta);
            let y = r * Math.sin(theta);
            return [x, y];
        }

        function dot(ctx, x, y) {
            let radius = 5;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, TAU);
            ctx.fill();
        }

        function coords(id, numNodes) {
            let center = 250;
            let radius = 150;

            let [x, y] = toCartesian(radius, TAU * (id / numNodes) + TAU * 3 / 4);
            return [x + center, y + center];
        }

        function textCoords(id, numNodes) {
            let center = 250;
            let radius = 200;

            let [x, y] = toCartesian(radius, TAU * (id / numNodes) + TAU * 3 / 4);
            return [x + center, y + center];
        }

        function render() {

            let canvas = document.getElementById("canvas");
            let ctx = canvas.getContext("2d");
            ctx.font = "24px serif";
            ctx.textAlign = "center";

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let index in nodes) {
                let [x, y] = coords(index, nodes.length);
                dot(ctx, x, y);

                let [textX, textY] = textCoords(index, nodes.length);
                let text = nodes[index].name;
                ctx.fillText(text, textX, textY);
            }
        }

        function updateNodes() {
            let nodeElements = document.getElementsByClassName("node");
            nodes = [];
            for (elem of nodeElements) {
                let data = {
                    id: extractId(elem.id),
                    name: elem.value
                };
                nodes.push(data);
            }

            updateEdgeTables();
        }

        function selectSrc(id) {
            selectedSrc = id;
        }

        function selectDst(id) {
            edges.push({
                // TODO edge itself needs an ID?
                src: selectedSrc,
                dst: id
            })
        }

        function updateEdgeTables() {
            let addEdgeBody = document.getElementById("addEdgeBody");
            let trs = [];
            for (let node of nodes) {
                let tr = document.createElement("tr");

                // TODO need stable IDs: cannot just recreate each time (?)
                // TODO or maybe relate these IDs to the node IDs!
                // node123 <-> src123 <-> dst123
                // do these even actually need IDs?
                let buttonFrom = document.createElement("button");
                buttonFrom.innerText = node.name || "_";
                buttonFromId = mkId("src", node.id);
                buttonFrom.id = buttonFromId;
                buttonFrom.onclick = () => { selectSrc(node.id); updateNodes(); }
                let tdFrom = document.createElement("td");
                tdFrom.appendChild(buttonFrom);
                tr.appendChild(tdFrom);

                let buttonTo = document.createElement("button");
                buttonTo.innerText = node.name || "_";
                buttonToId = mkId("dst", node.id);
                buttonTo.id = buttonToId;
                buttonTo.onclick = () => { selectDst(node.id); updateNodes(); }
                buttonTo.disabled = (selectedSrc === null);
                let tdTo = document.createElement("td");
                tdTo.appendChild(buttonTo);
                tr.appendChild(tdTo);

                trs.push(tr);
            }

            addEdgeBody.replaceChildren(...trs);
        }

        function addNode() {
            let nodeBody = document.getElementById("nodeBody");
            let nodeTr = document.createElement("tr");

            let nameTd = document.createElement("td");
            let nameBox = document.createElement("input");
            nameBox.className = "node";
            nameBox.id = randomId("node");
            nameBox.onkeyup = () => { updateNodes(); render(); }
            nameTd.appendChild(nameBox);
            nodeTr.appendChild(nameTd);

            let removeTd = document.createElement("td");
            let removeButton = document.createElement("button");
            removeButton.onclick = () => { nodeTr.remove(); updateNodes(); render(); }
            removeButton.innerText = "Remove";
            removeTd.appendChild(removeButton);
            nodeTr.appendChild(removeTd);

            nodeBody.appendChild(nodeTr);

            updateNodes();

            render();
        }

    </script>
</head>
<body>
    <canvas id="canvas" width="500" height="500"></canvas>
    <table>
        <thead>
            <tr>
                <th colspan="2">Nodes</th>
            </tr>
        </thead>
        <tbody id="nodeBody">
        </tbody>
        <tfoot>
            <tr><td colspan="2"><button onclick="addNode();">Add</button></td></tr>
        </tfoot>
    </table>
    <table>
        <thead>
            <tr>
                <th>Node 1</th>
                <th>Node 2</th>
            </tr>
        </thead>
        <tbody id="addEdgeBody">
        </tbody>
    </table>
    <table>
        <thead>
            <th>Node 1</th>
            <th>Node 2</th>
            <th></th>
        </thead>
        <tbody id="deleteBody">
        </tbody>
    </table>
</body>
</html>