<!DOCTYPE html>
<html>
<head>
<script src="https://cwjs.mastercw.com/cw.min.js"></script>
<script src="https://neil.fraser.name/software/diff_match_patch/javascript/diff_match_patch.js"></script>
<script>
    var secretText = "";

    function addToCounter(counter, key) {
        let curr = counter.get(key);
        if (curr === undefined) {
            counter.set(key, 1);
        } else {
            counter.set(key, curr + 1);
        }
    }

    function getResult() {
        let solution = document.getElementById("solution");
        let submission = document.getElementById("submission");
        let base = solution.value;
        let changed = submission.value;

        let diffs = (new diff_match_patch).diff_main(base, changed);

        let correct = new Map();
        let incorrect = new Map();
        for (let diff of diffs) {
            console.log(diff[0]);
            console.log(diff[1]);
            let isCorrect = (diff[0] === 0);
            let letters = diff[1];
            for (let i = 0; i < letters.length; i++) {
                let letter = letters.charAt(i);
                if (isCorrect) {
                    addToCounter(correct, letter);
                } else {
                    addToCounter(incorrect, letter);
                }
            }
        }

        let totalCorrect = 0;
        let totalIncorrect = 0;
        for (let kv of correct) {
            totalCorrect += kv[1];
        }
        for (let kv of incorrect) {
            totalIncorrect += kv[1];
        }

        let resultBody = document.getElementById("resultBody");
        let totalRow = document.createElement("tr");
        let totalLabel = document.createElement("td");
        let correctTd = document.createElement("td");
        let sumTd = document.createElement("td");
        let percentTd = document.createElement("td");
        totalLabel.innerText = "Total";
        correctTd.innerText = totalCorrect;
        sumTd.innerText = totalCorrect + totalIncorrect;
        percentTd.innerText = Math.round(totalCorrect * 100 / (totalCorrect + totalIncorrect)) + "%";
        totalRow.appendChild(totalLabel);
        totalRow.appendChild(correctTd);
        totalRow.appendChild(sumTd);
        totalRow.appendChild(percentTd);
        resultBody.appendChild(totalRow);

        // TODO append rows for all the letters, worst to best
    }

    function play() {
        let wpm = document.getElementById("wpm").value;
        cw.play(secretText, {wpm});
    }

    function randomChoice(arr) {
        return arr[randomInt(0, arr.length)];
    }

    function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min)) + min;
    }

    function randomWord(alphabet, wordMin, wordMax) {
        let word = "";
        let length = randomInt(wordMin, wordMax);
        for (let i = 0; i < length; i++) {
            word += randomChoice(alphabet);
        }
        return word;
    }
    
    function makeRandomText(alphabet, wordMin, wordMax, length) {
        let text = "";
        while (text.length < length) {
            text += randomWord(alphabet, wordMin, wordMax) + " ";
        }
        return text.slice(0, length);
    }

    function generate() {
        let alphabet = document.getElementById("alphabet").value;
        let wordMin = parseInt(document.getElementById("wordMin").value);
        let wordMax = parseInt(document.getElementById("wordMax").value);
        let length = parseInt(document.getElementById("length").value);

        let solution = document.getElementById("solution");

        let text = makeRandomText(alphabet, wordMin, wordMax, length);
        secretText = text;
        solution.value = "*".repeat(length);
    }

    function showSolution() {
        let solution = document.getElementById("solution");
        solution.value = secretText;
    }

    onload = function() {
        

    }
</script>
</head>
<body>
<table>
    <thead>
        <tr>
            <th colspan="2">Morse Code Practice</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Alphabet</td>
            <td>
                <input id="alphabet"/>
            </td>
        </tr>
        <tr>
            <td>Word Length</td>
            <td>
                <input id="wordMin" type="number" value="1"/>
                <input id="wordMax" type="number" value="7"/>
            </td>
        </tr>
        <tr>
        <td>Text Length</td>
            <td>
                <input id="length" type="number" value="100"/>
            </td>
        </tr>
        <tr>
            <td>Word Speed</td>
            <td>
                <input id="wpm" type="number" value="15"/>
            </td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td colspan="2">
                <button id="generate" onclick="generate();">
                    Generate
                </button>
                <button id="play" onclick="play();">
                    Play
                </button>
            </td>
        </tr>
    </tfoot>
</table>
<table>
    <thead>
        <tr>
            <th>Submission</th>
            <th>Solution</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
                <textarea id="submission"></textarea>
            </td>
            <td>
                <textarea id="solution" disabled="true"></textarea>
            </td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td colspan="2">
                <button id="showSolution" onclick="showSolution();">
                    Show Solution
                </button>
                <button id="getResult" onclick="getResult();">
                    Get Result
                </button>
            </td>
        </tr>
    </tfoot>
</table>
<table>
    <thead>
        <tr>
            <th colspan="2">Result</th>
        </tr>
    </thead>
    <tbody id="resultBody"></tbody>
</table>
</body>
</html>