<!DOCTYPE html>
<html>
<head>
<style>
    table {
        border: 1px solid black;
        margin: 2px;
        margin-left: auto;
        margin-right: auto;
    }
    th {
        padding: 3px;
    }
    .centerblock {
        margin-left: auto;
        margin-right: auto;
        display: block;
    }
</style>
<script src="https://fkurz.net/ham/jscwlib/releases/jscwlib-0.3.0.js"></script>
<script src="https://neil.fraser.name/software/diff_match_patch/javascript/diff_match_patch.js"></script>
<script>
    // TODO log results separately
    // TODO recommend promotion:
        // if confidence >90% then promote
        // increase wpm, increase character speed if wpm would be greater
        // reset result table for new speed
    // TODO make update function update all config info
    var secretText = "";
    var scores = [];

    let cw = new jscw()

    cw.onPlay = () => { 
        document.getElementById("play").disabled = true;
        document.getElementById("stop").disabled = false;
    };

    cw.onFinished = () => {
        document.getElementById("play").disabled = false;
        document.getElementById("stop").disabled = true;
    }

    function lowerBoundRate(successes, total) {
        // Agresti-Coull method
        let n_s = successes;
        let n = total;
        let z_a = 1.96;
        let n_bar = n + z_a * z_a;
        let p_bar = (1 / n_bar) * (n_s + (z_a * z_a) / 2)
        return p_bar - z_a * Math.sqrt((p_bar * (1 - p_bar)) / n_bar);
    }

    function calcConfidence(successes, total) {
        let lowerBound = null;
        if (total === 0) {
            lowerBound = 0;
        } else {
            lowerBound = Math.max(lowerBoundRate(successes, total), 0);
        }
        return lowerBound;
    }

    function addNToCounter(counter, key, n) {
        let curr = counter.get(key);
        if (curr === undefined) {
            counter.set(key, n);
        } else {
            counter.set(key, curr + n);
        }
    }

    function addToCounter(counter, key) {
        addNToCounter(counter, key, 1)
    }

    function displayResult() {
        let totalCorrect = 0;
        let totalAttempted = 0;
        for (let score of scores) {
            console.log(score.num)
            totalCorrect += score.correct;
            totalAttempted += score.total;
        }

        let resultBody = document.getElementById("resultBody");
        resultBody.replaceChildren();
        let totalRow = document.createElement("tr");
        let totalLabel = document.createElement("td");
        let correctTd = document.createElement("td");
        let sumTd = document.createElement("td");
        let percentTd = document.createElement("td");
        let confidenceTd = document.createElement("td");
        totalLabel.innerText = "Total";
        correctTd.innerText = totalCorrect;
        sumTd.innerText = totalAttempted;
        percentTd.innerText = Math.round(totalCorrect * 100 / totalAttempted) + "%";
        confidenceTd.innerText = Math.round(calcConfidence(totalCorrect, totalAttempted) * 100) + "%";
        totalRow.appendChild(totalLabel);
        totalRow.appendChild(correctTd);
        totalRow.appendChild(sumTd);
        totalRow.appendChild(percentTd);
        totalRow.appendChild(confidenceTd);
        resultBody.appendChild(totalRow);

        // sort by reverse total first
        // because a 0 with lots of tries is worse than a 0 with few
        scores.sort((s1, s2) => s2.total - s1.total);
        scores.sort((s1, s2) => s1.confidence - s2.confidence);
        for (let score of scores) {
            let row = document.createElement("tr");
            let labelTd = document.createElement("td");
            let correctTd = document.createElement("td");
            let totalTd = document.createElement("td");
            let percentTd = document.createElement("td");
            let confidenceTd = document.createElement("td");

            let reminderButton = document.createElement("button");
            reminderButton.innerText = score.letter;
            reminderButton.onclick = () => {
                let wpm = document.getElementById("wpm").value;
                cw.setWpm(wpm);
                cw.play(score.letter);
            }

            labelTd.appendChild(reminderButton);
            correctTd.innerText = score.correct;
            totalTd.innerText = score.total;
            percentTd.innerText = Math.round(score.rate * 100) + "%";
            confidenceTd.innerText = Math.round(score.confidence * 100) + "%";


            row.appendChild(labelTd);
            row.appendChild(correctTd);
            row.appendChild(totalTd);
            row.appendChild(percentTd);
            row.appendChild(confidenceTd);

            resultBody.appendChild(row);
        }

        document.getElementById("showSolution").disabled = false;
        document.getElementById("addToResult").disabled = true;
        document.getElementById("resetResult").disabled = false;
        document.getElementById("importResult").disabled = true;
        document.getElementById("exportResult").disabled = false;
        document.getElementById("play").disabled = false;
        document.getElementById("useRecommendedAlphabet").disabled = false;
    }

    function addToResult() {
        // TODO separate score tracking and displaying
        let submission = document.getElementById("submission");
        let base = secretText;
        let changed = submission.value;

        let diffs = (new diff_match_patch).diff_main(base, changed);


        let alphabet = document.getElementById("alphabet").value;
        let correct = new Map();
        let incorrect = new Map();
        for (let i = 0; i < alphabet.length; i++) {
            correct.set(alphabet.charAt(i), 0);
            incorrect.set(alphabet.charAt(i), 0);
        }
        
        for (let diff of diffs) {
            let isCorrect = (diff[0] === 0);
            let letters = diff[1];
            for (let i = 0; i < letters.length; i++) {
                let letter = letters.charAt(i);
                if (letter !== " ") {
                    if (isCorrect) {
                        addToCounter(correct, letter);
                    } else {
                        addToCounter(incorrect, letter);
                    }
                }
            }
        }

        // add the scores from last time
        for (let score of scores) {
            addNToCounter(correct, score.letter, score.correct);
            addNToCounter(incorrect, score.letter, score.total - score.correct);
        }

        scores = [];
        for (kv of correct) {
            let letter = kv[0];
            let numCorrect = kv[1];
            let numIncorrect = incorrect.get(letter);
            let sum = numCorrect + numIncorrect;
            let percent = numCorrect / sum;
            let confidence = calcConfidence(numCorrect, sum);
            let score = {
                letter: letter,
                correct: numCorrect,
                total: sum,
                rate: percent,
                confidence: confidence,
            };
            scores.push(score);
        }

        displayResult()
    }

    function resetResult() {
        scores = []
        document.getElementById("resultBody").replaceChildren();

        document.getElementById("showSolution").disabled = false;
        document.getElementById("addToResult").disabled = false;
        document.getElementById("resetResult").disabled = true;
        document.getElementById("importResult").disabled = false;
        document.getElementById("exportResult").disabled = true;
        document.getElementById("play").disabled = false;
        document.getElementById("useRecommendedAlphabet").disabled = true;
    }



    function useRecommendedAlphabet() {
        let newAlphabet = "";
        for (let score of scores) {
            let count = 100 - score.confidence * 100;
            newAlphabet += score.letter.repeat(count);
        }
        
        document.getElementById("alphabet").value = newAlphabet;
    }

    function play() {
        cw.play(secretText);
    }

    function stop() {
        cw.stop();
        document.getElementById("play").disabled = false;
        document.getElementById("stop").disabled = true;
    }

    function randomChoice(arr) {
        return arr[randomInt(0, arr.length)];
    }

    function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min)) + min;
    }

    function randomWord(alphabet, wordMin, wordMax) {
        let word = "";
        let length = randomInt(wordMin, wordMax);
        for (let i = 0; i < length; i++) {
            word += randomChoice(alphabet);
        }
        return word;
    }
    
    function makeRandomText(alphabet, wordMin, wordMax, length) {
        let text = "";
        let currentLength = 0;
        while (currentLength < length) {
            let word = randomWord(alphabet, wordMin, wordMax);
            text += word + " ";
            currentLength += word.length;
        }
        return text;
    }

    function update() {
        let wpm = document.getElementById("charSpeed").value;
        cw.setWpm(wpm);

        let eff = document.getElementById("wordSpeed").value;
        cw.setEff(eff);
    }

    function importResult() {
        let result = prompt("Paste the result JSON string here.");
        if (result !== null && result !== "") {
            try {
                let parsed = JSON.parse(result);
                scores = parsed;
                displayResult();
            } catch (error) {
                alert("Invalid JSON")
            }
        }
    }

    function exportResult() {
        let json = JSON.stringify(scores);
        alert(json);
    }

    function generate() {
        let alphabet = document.getElementById("alphabet").value;
        let wordMin = parseInt(document.getElementById("wordMin").value);
        let wordMax = parseInt(document.getElementById("wordMax").value);
        let length = parseInt(document.getElementById("length").value);

        let solution = document.getElementById("solution");

        let text = makeRandomText(alphabet, wordMin, wordMax, length);
        secretText = text;
        solution.value = "*".repeat(length);


        document.getElementById("submission").value = "";
        document.getElementById("showSolution").disabled = false;
        document.getElementById("addToResult").disabled = false;
        document.getElementById("play").disabled = false;
        document.getElementById("useRecommendedAlphabet").disabled = true;
    }

    function showSolution() {
        let solution = document.getElementById("solution");
        solution.value = secretText;
    }

    // initialize the options
    document.onload = update;
</script>
</head>
<body>
<table>
    <thead>
        <tr>
            <th colspan="2">Morse Code Practice</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Alphabet</td>
            <td>
                <input id="alphabet" value="kmrsuaptlowi.njef0y,vg5/q9zh38b?427c1d6x"/>
            </td>
        </tr>
        <tr>
            <td>Word Length</td>
            <td>
                <input id="wordMin" type="number" value="1"/>
                <input id="wordMax" type="number" value="7"/>
            </td>
        </tr>
        <tr>
        <td>Text Length</td>
            <td>
                <input id="length" type="number" value="100"/>
            </td>
        </tr>
        <tr>
            <td>Word Speed</td>
            <td>
                <input id="wordSpeed" type="number" value="10" onkeyup="update();"/>
            </td>
        </tr>
        <tr>
            <td>Character Speed</td>
            <td>
                <input id="charSpeed" type="number" value="20" onkeyup="update();"/>
            </td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td colspan="2">
                <button id="generate" onclick="generate();">
                    Generate
                </button>
                <button id="play" onclick="play();" disabled="true">
                    Play
                </button>
                <button id="stop" onclick="stop();" disabled="true">
                    Stop
                </button>
            </td>
        </tr>
    </tfoot>
</table>
<table>
    <tbody>
        <tr>
            <th>Submission</th>
            <td>
                <input id="submission" class="centerblock" size="100"/>
            </td>
            <tr>
            <th>Solution</th>
            <td>
                <input id="solution" class="centerblock" size="100" disabled="true"/>
            </td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td colspan="2" align="center">
                <button id="showSolution" onclick="showSolution();" disabled="true">
                    Show Solution
                </button>
                <button id="addToResult" onclick="addToResult();" disabled="true">
                    Add to Result
                </button>
                <button id="resetResult" onclick="resetResult();" disabled="true">
                    Reset Result
                </button>
                <button id="importResult" onclick="importResult();">
                    Import Result
                </button>
                <button id="exportResult" onclick="exportResult();" disabled="true">
                    Export Result
                </button>
                <button id="useRecommendedAlphabet" onclick="useRecommendedAlphabet();" disabled="true">
                    Use Recommended Alphabet
                </button>
            </td>
        </tr>
    </tfoot>
</table>
<table>
    <thead>
        <tr>
            <th colspan="5">Result</th>
        </tr>
        <tr>
            <th>Letter</th>
            <th>Correct</th>
            <th>Total</th>
            <th>Percent</th>
            <th>Confidence</th>
        </tr>
    </thead>
    <tbody id="resultBody", style="text-align: right;"></tbody>
</table>
</body>
</html>