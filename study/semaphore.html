<!DOCTYPE html>
<html>
<head>
<template id="semaphore-romeo">
<svg xmlns="http://www.w3.org/2000/svg" width="600" height="500" version="1.0">
<circle cx="300" cy="210" r="25"/>
<rect x="265" y="240" height="160" width="70" rx="20" ry="20"/>
<g id="armL">
<rect x="340" y="240" width="70" height="20" rx="10" ry="10"/>
<path d="M399,244.5h200.5v101h-91v-90h-110z"/>
<path d="M509.5,255.5h89v89h-89z" fill="#ff0"/>
<path d="M509.5,255.5l89,89v-89z" fill="#f00"/>
</g>
<g 
    transform="rotate(90 250 250)"
    id="armR">
<rect x="190" y="240" width="70" height="20" rx="10" ry="10"/>
<path d="M0,244.5h200.5v11h-110v90h-91z"/>
<path d="M.5,255.5h89v89h-89z" fill="#ff0"/>
<path d="M.5,255.5h89l-89,89z" fill="#f00"/>
</g>
<circle cx="250" cy="250" r="5" fill = "pink"/>
<circle cx="350" cy="250" r="5" fill = "pink"/>
</svg>
</template>
<script>
const svgNamespace = "http://www.w3.org/2000/svg";
const leftX = 350;
const leftY = 250;
const rightX = 250;
const rightY = 250;

let positions = new Map();
positions.set("a", [135, 180]);
positions.set("b", [90, 180]);
positions.set("c", [45, 180]);
positions.set("d", [0, 180]);
positions.set("e", [180, 45]);
positions.set("f", [180, 90]);
positions.set("g", [180, 135]);
positions.set("h", [90, 225]);
positions.set("i", [45, 225]);
positions.set("j", [0, 90]);
positions.set("k", [135, 0]);
positions.set("l", [135, 45]);
positions.set("m", [135, 90]);
positions.set("n", [135, 135]);
positions.set("o", [90, -45]);
positions.set("p", [90, 0]);
positions.set("q", [90, 45]);
positions.set("r", [90, 90]);
positions.set("s", [90, 135]);
positions.set("t", [45, 0]);
positions.set("u", [45, 45]);
positions.set("v", [0, 135]);
positions.set("w", [-45, 90]);
positions.set("x", [-45, 135]);
positions.set("y", [45, 90]);
positions.set("z", [-135, 90]);
positions.set(" ", [180, 180]);
positions.set("#", [0, 45]);
positions.set("<", [45, 135]);

function getLeftDir(char) {
    return 270 + positions.get(char)[0];
}

function getLeftRot(char) {
    return `${getLeftDir(char)} ${leftX} ${leftY}`;
}

function getRightDir(char) {
    return 90 - positions.get(char)[1];
}

function getRightRot(char) {
    return `${getRightDir(char)} ${rightX} ${rightY}`;
}

// returns an svg node corresponding to the given character
function draw(string) {
    let template = document.getElementById("semaphore-romeo");
    let node = template.content.cloneNode(true);
    // node.getElementById("armL").setAttribute("transform", "rotate(" + getLeftRot(char) + ")");
    // node.getElementById("armR").setAttribute("transform", "rotate(" + getRightRot(char) + ")");

    for (let step of makeAnimationSteps(string, 1000)) {
        node.getElementById("armL").appendChild(step.left);
        node.getElementById("armR").appendChild(step.right);
    }
    return node;
}

function animate(string, speed, canvas) {
    // create an svg
    // start with semaphore: romeo
    // for each letter:
        // append animation from previous position
        // need a from-to function to animate from one letter to the next
        // ensure each animation starts after the previous
        // arms move at once
        // probably pause between movements (configurable duration)
        
    // TODO displays the string as semaphore on the given canvas
}

// returns a { "left": node, "right": node } pair
function makeAnimationStep(from, to, dur) {
    let animLeft = document.createElementNS(svgNamespace, "animateTransform");
    animLeft.setAttribute("attributeName", "transform");
    animLeft.setAttribute("type", "rotate");
    animLeft.setAttribute("from", getLeftRot(from));
    animLeft.setAttribute("to", getLeftRot(to));
    animLeft.setAttribute("dur", dur + "ms");
    animLeft.setAttribute("fill", "freeze");
    // animLeft.setAttribute("repeatCount", "indefinite");

    let animRight = document.createElementNS(svgNamespace, "animateTransform");
    animRight.setAttribute("attributeName", "transform");
    animRight.setAttribute("type", "rotate");
    animRight.setAttribute("from", getRightRot(from));
    animRight.setAttribute("to", getRightRot(to));
    animRight.setAttribute("dur", dur + "ms");
    animRight.setAttribute("fill", "freeze");

    return {
        "left": animLeft,
        "right": animRight
    };
}

// given a list of animation steps, adds timings to them so they start in sequence
function sequenceSteps(steps, dur) {
    for (let i = 0; i < steps.length; i++) {
        let beginTime = dur * i;
        steps[i].left.setAttribute("begin", beginTime + "ms");
        steps[i].right.setAttribute("begin", beginTime + "ms");
    }
}

// creates a list of animation steps in sequence
function makeAnimationSteps(string, dur) {
    let chars = " " + string + " ";
    let steps = []
    for (let i = 1; i < chars.length; i++) {
        steps.push(makeAnimationStep(chars.charAt(i - 1), chars.charAt(i), dur));
    }
    sequenceSteps(steps, dur);
    return steps;
}

function drawFrame(left, right, canvas) {
    // TODO displays figure with arms turned to the given angle
}

onload = () => {
    document.getElementById("canvas").replaceWith(draw("hello"));
}
// canvas for display
// alphabet
// speed controls
// submission
// solution
// steal from morse code stuff
</script>
</head>
<body>
    <svg id="canvas"></svg>
</body>
</html>